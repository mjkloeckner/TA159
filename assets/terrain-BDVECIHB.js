import{S as _,W as ee,P as te,O as ne,A as ae,H as oe,D as re,t as se,G as ie,a as le,T as de,J as ce,b as X,c as V,z as ue,M as U,R as fe,L as pe,v as me,C as we,I as q,l as J,m as xe,h as k,n as ye,V as R,o as E}from"./OrbitControls-CgjfdclN.js";import{v as ve,f as ge}from"./shaders-Dk4hn-4p.js";import{t as he,r as Me,p as Le}from"./pasto-JkRKC7jR.js";import{e as be}from"./elevation_map_wider_river-Cbe3WljM.js";let u,M,A,T,L,O,B;const h=100,G=100,F=8,N=-1,v={tierra:{url:he,object:null},roca:{url:Me,object:null},pasto:{url:Le,object:null},elevationMap:{url:be,object:null}};function Y(){M.aspect=T.offsetWidth/T.offsetHeight,M.updateProjectionMatrix(),A.setSize(T.offsetWidth,T.offsetHeight)}function Ge(){u=new _,T=document.getElementById("mainContainer"),A=new ee,A.setClearColor(6316128),T.appendChild(A.domElement),M=new te(35,window.innerWidth/window.innerHeight,.1,1e3),M.position.set(100,120,-100),M.lookAt(0,0,0),new ne(M,A.domElement);const e=new ae(16777215);u.add(e),new oe(16777215,0,.25);const t=new re(16777215,1);t.position.set(100,100,100),u.add(t),new se(t,5);const s=new ie(150,150);u.add(s);const n=new le(5);u.add(n),window.addEventListener("resize",Y),Y()}function Z(){let e=document.createElement("canvas"),t=e.getContext("2d"),s=v.elevationMap.object.image;e.width=h,e.height=G,t.drawImage(s,0,0,h,G);let a=t.getImageData(0,0,h,G).data;const d=Math.random(),i=Math.random(),f=Math.floor(d*h),l=Math.floor(i*G),p=a[(f+l*h)*4]/255;return new R((d-.5)*h,p*F,(i-.5)*G)}function Ae(e){console.log("Generating `"+e+"` instances of tree");let t=4;const s=new we(.3,.3,t,40,40);s.translate(0,t/2,0);const n=new q;n.copy(s);const a=new U({color:8142592}),d=new J(n,a,e),i=new xe(1.75,40,40),f=new q;f.copy(i);const l=new U({color:3561513}),p=new J(f,l,e);new k;const m=new k,c=new k,w=new k;for(let b=0;b<e;b++){let y=Z(),g=0;for(;(y.y>4||y.y<2.5)&&(y=Z(),g++!=100););y.y+=N,m.makeTranslation(y),c.identity(),w.identity();let x=.5+Math.random()*(t/3);c.makeScale(1,x,1),c.premultiply(m),y.y+=x*t,m.makeTranslation(y),w.premultiply(m),d.setMatrixAt(b,c),p.setMatrixAt(b,w)}return[d,p]}function Te(e,t,s,n,a,d){console.log("Generating terrain geometry");let i=new ye;const f=[],l=[],p=[],m=[];let c=document.createElement("canvas"),w=c.getContext("2d"),b=d.image;c.width=n,c.height=a,w.drawImage(b,0,0,n,a);let g=w.getImageData(0,0,n,a).data;const x=n-1;for(let o=0;o<n-1;o++)for(let r=0;r<a-1;r++){let H,W,z,j,I=g[(o+r*n)*4]/255;H=o>0?g[(o-1+r*n)*4]/255:void 0,W=o<n-1?W=g[(o+1+r*n)*4]/255:void 0,z=r>0?g[(o+(r-1)*n)*4]/255:void 0,j=r<a-1?g[(o+(r+1)*n)*4]/255:void 0;let C;H==null?C=W-I:j==null?C=H-I:C=(W-H)/2;let D;z==null?D=j-I:j==null?D=z-I:D=(j-z)/2;const K=s*I;f.push(e*o/n-e/2),f.push(K),f.push(t*r/a-t/2);let Q=new R(e/n,C*s,0).normalize(),S=new R(0,D*s,t/a).normalize(),P=new R;P.crossVectors(S,Q),p.push(P.x),p.push(P.y),p.push(P.z),m.push(o/(n-1)),m.push(r/(a-1)),!(o==n-2||r==a-2)&&(l.push(o+r*x),l.push(o+1+r*x),l.push(o+1+(r+1)*x),l.push(o+r*x),l.push(o+1+(r+1)*x),l.push(o+(r+1)*x))}return i.setAttribute("position",new E(f,3)),i.setAttribute("normal",new E(p,3)),i.setAttribute("uv",new E(m,2)),i.setIndex(l),i}function je(){console.log("Building scene");const e=100,t=100;O=Te(e,t,F,h,G,v.elevationMap.object),console.log("Applying textures"),L=new ce({uniforms:{dirtSampler:{type:"t",value:v.tierra.object},rockSampler:{type:"t",value:v.roca.object},grassSampler:{type:"t",value:v.pasto.object},scale:{type:"f",value:3},terrainAmplitude:{type:"f",value:F},terrainAmplitudeBottom:{type:"f",value:N},worldNormalMatrix:{type:"m4",value:null},dirtStepWidth:{type:"f",value:.2},rockStepWidth:{type:"f",value:.15}},vertexShader:ve,fragmentShader:ge,side:X}),B=new V(O,L),L.onBeforeRender=(f,l,p,m,c)=>{let w=c.matrixWorld.clone();w=w.transpose().invert(),c.material.uniforms.worldNormalMatrix.value=w},L.needsUpdate=!0,u.add(B),B.position.set(0,N,0),u.add(B),console.log("Generating water");const s=new ue(e/2,t),n=new U({color:1223679,side:X}),a=new V(s,n);a.rotateX(Math.PI/2),a.position.set(0,.75,0),u.add(a);const[d,i]=Ae(100);u.add(d),u.add(i)}function Ie(e,t){t.wrapS=t.wrapT=fe,v[e].object=t,console.log("Texture `"+e+"` loaded")}function He(e){const t=new pe;t.onLoad=()=>{console.log("All textures loaded"),e()};for(const s in v){console.log("Loading textures");const n=new de(t),a=v[s];a.object=n.load(a.url,Ie.bind(this,s),null,d=>{console.error(d)})}}function We(){const e=new me({width:400});e.add(L.uniforms.scale,"value",1,5).name("Terrain texture scale"),e.add(L.uniforms.dirtStepWidth,"value",0,1).name("dirt step width"),e.add(L.uniforms.rockStepWidth,"value",.1,.5).name("rock step width")}function $(){requestAnimationFrame($),A.render(u,M)}Ge();He(ze);function ze(){je(),We(),$()}
