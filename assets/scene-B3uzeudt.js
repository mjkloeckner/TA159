import{V as f,i as Dt,j as Ht,k as vt,M as L,F as G,c as j,C as H,B as z,e as xt,f as Mt,E as kt,T as Ge,R as J,L as Ee,I as rt,l as it,m as Rt,h as Y,n as Bt,o as He,d as st,g as Pt,P as le,S as Vt,W as Ut,p as _t,O as Nt,A as Xt,H as Wt,D as Ot,q as Zt,r as Ne,s as $t,t as qt,G as Kt,a as Yt,u as ct,v as Jt,w as Qt,x as Re,y as St,z as eo}from"./OrbitControls-CgjfdclN.js";import{m as be}from"./BufferGeometryUtils-DQFymryo.js";import{e as tt}from"./elevation_map_wider_river-Cbe3WljM.js";import{t as Ct}from"./tree_forbidden_zone_map_wider_path-Bzrj_VaQ.js";import{t as jt,r as Ft,p as Lt}from"./pasto-JkRKC7jR.js";import{t as to,l as oo}from"./pared_de_ladrillo-koNbRcn4.js";import{P as Xe,d as no}from"./durmientes-BJG45Nyc.js";import{m as ao}from"./madera-BY2TwKea.js";const me=new Ht(0,0,0,"YXZ"),ue=new f,ro={type:"change"},io={type:"lock"},so={type:"unlock"},lt=Math.PI/2;class co extends Dt{constructor(o,e){super(),this.camera=o,this.domElement=e,this.isLocked=!1,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.pointerSpeed=1,this._onMouseMove=lo.bind(this),this._onPointerlockChange=mo.bind(this),this._onPointerlockError=uo.bind(this),this.connect()}connect(){this.domElement.ownerDocument.addEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.addEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.addEventListener("pointerlockerror",this._onPointerlockError)}disconnect(){this.domElement.ownerDocument.removeEventListener("mousemove",this._onMouseMove),this.domElement.ownerDocument.removeEventListener("pointerlockchange",this._onPointerlockChange),this.domElement.ownerDocument.removeEventListener("pointerlockerror",this._onPointerlockError)}dispose(){this.disconnect()}getObject(){return this.camera}getDirection(o){return o.set(0,0,-1).applyQuaternion(this.camera.quaternion)}moveForward(o){const e=this.camera;ue.setFromMatrixColumn(e.matrix,0),ue.crossVectors(e.up,ue),e.position.addScaledVector(ue,o)}moveRight(o){const e=this.camera;ue.setFromMatrixColumn(e.matrix,0),e.position.addScaledVector(ue,o)}lock(){this.domElement.requestPointerLock()}unlock(){this.domElement.ownerDocument.exitPointerLock()}}function lo(t){if(this.isLocked===!1)return;const o=t.movementX||t.mozMovementX||t.webkitMovementX||0,e=t.movementY||t.mozMovementY||t.webkitMovementY||0,n=this.camera;me.setFromQuaternion(n.quaternion),me.y-=o*.002*this.pointerSpeed,me.x-=e*.002*this.pointerSpeed,me.x=Math.max(lt-this.maxPolarAngle,Math.min(lt-this.minPolarAngle,me.x)),n.quaternion.setFromEuler(me),this.dispatchEvent(ro)}function mo(){this.domElement.ownerDocument.pointerLockElement===this.domElement?(this.dispatchEvent(io),this.isLocked=!0):(this.dispatchEvent(so),this.isLocked=!1)}function uo(){console.error("THREE.PointerLockControls: Unable to use Pointer Lock API")}var ve=function(){var t=0,o=document.createElement("div");o.style.cssText="position:fixed;top:0;left:0;cursor:pointer;opacity:0.9;z-index:10000",o.addEventListener("click",function(s){s.preventDefault(),n(++t%o.children.length)},!1);function e(s){return o.appendChild(s.dom),s}function n(s){for(var u=0;u<o.children.length;u++)o.children[u].style.display=u===s?"block":"none";t=s}var a=(performance||Date).now(),r=a,i=0,c=e(new ve.Panel("FPS","#0ff","#002")),l=e(new ve.Panel("MS","#0f0","#020"));if(self.performance&&self.performance.memory)var h=e(new ve.Panel("MB","#f08","#201"));return n(0),{REVISION:16,dom:o,addPanel:e,showPanel:n,begin:function(){a=(performance||Date).now()},end:function(){i++;var s=(performance||Date).now();if(l.update(s-a,200),s>=r+1e3&&(c.update(i*1e3/(s-r),100),r=s,i=0,h)){var u=performance.memory;h.update(u.usedJSHeapSize/1048576,u.jsHeapSizeLimit/1048576)}return s},update:function(){a=this.end()},domElement:o,setMode:n}};ve.Panel=function(t,o,e){var n=1/0,a=0,r=Math.round,i=r(window.devicePixelRatio||1),c=80*i,l=48*i,h=3*i,s=2*i,u=3*i,y=15*i,v=74*i,k=30*i,p=document.createElement("canvas");p.width=c,p.height=l,p.style.cssText="width:80px;height:48px";var d=p.getContext("2d");return d.font="bold "+9*i+"px Helvetica,Arial,sans-serif",d.textBaseline="top",d.fillStyle=e,d.fillRect(0,0,c,l),d.fillStyle=o,d.fillText(t,h,s),d.fillRect(u,y,v,k),d.fillStyle=e,d.globalAlpha=.9,d.fillRect(u,y,v,k),{dom:p,update:function(g,x){n=Math.min(n,g),a=Math.max(a,g),d.fillStyle=e,d.globalAlpha=1,d.fillRect(0,0,c,y),d.fillStyle=o,d.fillText(r(g)+" "+t+" ("+r(n)+"-"+r(a)+")",h,s),d.drawImage(p,u+i,y,v-i,k,u,y,v-i,k),d.fillRect(u+v-i,y,i,k),d.fillStyle=e,d.globalAlpha=.9,d.fillRect(u+v-i,y,i,r((1-g/x)*k))}}};const oe=10,b=2.5,dt=b+.375,ce=2.5,ze=5,Z=6,ee=3,P=.375,fe=1.475,mt=2.5,ae=.425,Be=1.245,xe=-.45,Pe=4,ho=12,ut=1.5,We=.25;let Oe,Ze;function po(){return console.log("Building train cabin roof"),new z(6,P,6)}function wo(){console.log("Building train cabin");let t=[];const o=new z(b*2,P,Z);o.translate(0,ze/2,-Z/2),t.push(o);const e=new z(b*2,P,Z);e.rotateZ(Math.PI/2),e.translate(b-P/2,P/2,-Z/2),t.push(e);const n=new z(b*2,P,Z);n.rotateZ(Math.PI/2),n.translate(-b+P/2,P/2,-Z/2),t.push(n);const a=new z(P,P,ee);a.rotateZ(Math.PI/2),a.translate(-b+P/2,-b+P,-Z-ee/2),t.push(a);const r=new z(P,P,ee);r.rotateZ(Math.PI/2),r.translate(b-P/2,b,-Z-ee/2),t.push(r);const i=new z(P,P,ee);i.rotateZ(Math.PI/2),i.translate(b-P/2,-b+P,-Z-ee/2),t.push(i);const c=new z(P,P,ee);c.rotateZ(Math.PI/2),c.translate(-b+P/2,b,-Z-ee/2),t.push(c);const l=be(t);return l.rotateX(Math.PI/2),l}function fo(){let t=[];const o=new H(b,b,oe,32);t.push(o);const e=new H(dt,dt,ce,32);e.translate(0,oe/2+ce/2,0),t.push(e);const n=new z(b*2,oe+ce+ze,1);n.translate(0,-ce/2,b),t.push(n);const a=4,r=new H(.55,.55,a,32);r.translate(0,-(b+a/2)+1,-(oe+ce)/2),r.rotateX(Math.PI/2),t.push(r);const i=be(t);return i.rotateX(Math.PI/2),i.translate(0,b+.25,0),i}function he(){const t=new H(fe,fe,ae);t.rotateZ(Math.PI/2),new H(fe,fe,ae).rotateZ(Math.PI/2);const e=new L({color:3750201,side:G,shininess:100}),n=new j(t,e);return n.castShadow=!0,n.receiveShadow=!0,n}function Ve(t){const o=new H(.325,.325,5);o.rotateZ(Math.PI/2);const e=new L({color:8028032,side:G,shininess:100});return new j(o,e)}function go(){return new z(3.5,2.5,oe+ce+ze)}function bo(){console.log("Building train");const t=new vt,o=go(),e=new L({color:8028032,side:G,shininess:100}),n=new j(o,e);n.castShadow=!0,n.receiveShadow=!0,t.add(n);const a=fo(),r=new L({color:16390665,side:G,shininess:100}),i=new j(a,r);i.castShadow=!0,i.receive=!0,n.add(i),i.position.set(0,(mt+P)/2,Be);const c=wo(),l=new j(c,r);l.castShadow=!0,l.receive=!0,n.add(l),l.position.set(0,(mt+P)/2,-oe+ze/2+Be);const h=po(),s=new L({color:16510032,side:G,shininess:100}),u=new j(h,s);u.castShadow=!0,u.receive=!0,l.add(u),u.position.set(0,Z+ee+P/2,0);const y=Ve();n.add(y);const v=Ve();n.add(v);const k=Ve();n.add(k),y.position.set(0,xe,-.6),v.position.set(0,xe,-.6+fe*2.5),k.position.set(0,xe,-.6-fe*2.5);const p=new H(1.25,1.5,Pe);p.rotateX(Math.PI/2),p.translate(b-.25,-.25,oe-Pe/1.5);const d=new H(1.25,1.5,Pe);d.rotateX(Math.PI/2),d.translate(-b+.25,-.25,oe-Pe/1.5);const g=be([d,p]),x=new L({color:3750201,side:G,shininess:100}),A=new j(g,x);A.castShadow=!0,A.receiveShadow=!0,n.add(A),n.position.set(0,-2,-2.75);const R=he();R.position.set(b-ae/2.1,0,0),y.add(R);const _=he();_.position.set(-b+ae/2.1,0,0),y.add(_);const N=he();N.position.set(b-ae/2.1,0,0),v.add(N);const q=he();q.position.set(-b+ae/2.1,0,0),v.add(q);const X=he();X.position.set(b-ae/2.1,0,0),k.add(X);const B=he();B.position.set(-b+ae/2.1,0,0),k.add(B);const de=new z(We,.5,ho);Ze=new j(de,e),Oe=new j(de,e),n.add(Oe),n.add(Ze),Tt();const Q=1.1,W=new H(Q,Q,1,32);W.rotateX(Math.PI/2);const ne=new L({color:3750201,side:G,shininess:100,emissive:16175917}),at=new j(W,ne);return t.add(at),at.position.set(0,b+Be-Q/2-.3,(oe+ce)/2-.3),t.position.set(0,2,0),t}function Tt(t=0){Oe.position.set(-b-We/2,xe+.7*Math.sin(t*Math.PI/2),ut-.7*Math.cos(t*Math.PI/2)),Ze.position.set(b+We/2,xe+.7*Math.sin(t*Math.PI/2),ut-.7*Math.cos(t*Math.PI/2))}function yo(t=20,o=14,e=.5,n=26){const a=new xt;a.moveTo(-o/2,0),a.lineTo(-o/2,t*1/3),a.moveTo(-o/2,t*1/3),a.quadraticCurveTo(0,t,o/2,t*1/3),a.moveTo(o/2,0),a.lineTo(o/2,0),a.lineTo(o/2-e,0),a.moveTo(o/2-e,0),a.lineTo(o/2-e,t*1/3),a.moveTo(o/2-e,t*1/3),a.quadraticCurveTo(0,t-e*2,-o/2+e,t*1/3),a.lineTo(-o/2+e,0),a.moveTo(-o/2+e,0),a.lineTo(-o/2,0),a.moveTo(-o/2,0);const r=a.getPoints(),i=new Mt(r),c={curveSegments:24,steps:50,depth:n},l=new kt(i,c);return l.translate(1,0,-n/2),l}let $e,qe;const Me={elevationMap:{url:tt,object:null},treeForbiddenMap:{url:Ct,object:null}},ot=100,nt=100,vo=10,xo=-1;function Mo(t,o){let e=o*4,n=t.data;return[n[e],n[e+1],n[e+2],n[e+3]]}function At(t,o,e){return Mo(t,e*t.width+o)}function ht(t){const o=Math.floor(t.x),e=t.y,n=Math.floor(t.z);if(e>6.8||e<3.25)return!0;let a=At($e,o,n);const r=a[0],i=a[1],c=a[2];return r<=10&&i>=250&&c<=10||r<=80&&i<=80&&c<=80||r>=200&&i>=200&&c>=200}function pt(t=0){const o=Math.floor(Math.random()*(ot-t*2)),e=Math.floor(Math.random()*(nt-t*2)),a=At(qe,o,e)[0]/255*vo;return new f(o+t,a,e+t)}function ko(t){console.log("Generating `"+t+"` instances of tree");let o=3;const e=new H(.1,.25,o,40,40);e.translate(0,o/2,0);const n=new rt;n.copy(e);const a=new L({color:8142592,side:G}),r=new it(n,a,t),i=1.25,c=new Rt(i,40,40),l=new rt;l.copy(c);const h=new L({color:3561513}),s=new it(l,h,t);new Y;const u=new Y,y=new Y,v=new Y,k=3;for(let p=0;p<t;p++){let d=pt(k);for(let A=0;ht(d)&&(d=pt(k),A++!=1e3);++A);if(ht(d))continue;const g=-1.5;d.x-=(ot+k+1.5)/2,d.y+=xo+g,d.z-=(nt+k)/2,u.makeTranslation(d),y.identity(),v.identity();let x=.6+Math.random()*(o/3);y.makeScale(1,x,1),y.premultiply(u),d.y+=x*o,u.makeTranslation(d),v.premultiply(u),r.setMatrixAt(p,y),s.setMatrixAt(p,v)}return console.log("Done generating `"+t+"` instances of tree"),[r,s]}function Po(){console.log("Loading maps data");let t=document.createElement("canvas"),o=t.getContext("2d"),e=Me.treeForbiddenMap.object.image,n=Me.elevationMap.object.image;const a=ot,r=nt;t.width=a,t.height=r,o.drawImage(e,0,0,a,r),$e=o.getImageData(0,0,a,r),$e.data,o.drawImage(n,0,0,a,r),qe=o.getImageData(0,0,a,r),qe.data,console.log("All maps data loaded succesfully")}function So(t,o){o.wrapS=o.wrapT=J,Me[t].object=o,console.log("Texture `"+t+"` loaded")}function Co(t){const o=new Ee;o.onLoad=()=>{console.log("All textures loaded"),t()};for(const e in Me){console.log("Loading textures");const n=new Ge(o),a=Me[e];a.object=n.load(a.url,So.bind(this,e),null,r=>{console.error(r)})}}Co(Po);const Ke={tierra:{url:jt,object:null},roca:{url:Ft,object:null},pasto:{url:Lt,object:null},elevationMap:{url:tt,object:null}};function jo(t,o,e,n,a,r){console.log("Generating terrain geometry");let i=new Bt;const c=[],l=[],h=[],s=[];let u=document.createElement("canvas"),y=u.getContext("2d"),v=r.image;u.width=n,u.height=a,y.drawImage(v,0,0,n,a);let p=y.getImageData(0,0,n,a).data;const d=n-1;for(let g=0;g<n-1;g++)for(let x=0;x<a-1;x++){let A,R,_,N,q=p[(g+x*n)*4]/255;A=g>0?p[(g-1+x*n)*4]/255:void 0,R=g<n-1?R=p[(g+1+x*n)*4]/255:void 0,_=x>0?p[(g+(x-1)*n)*4]/255:void 0,N=x<a-1?p[(g+(x+1)*n)*4]/255:void 0;let X;A==null?X=R-q:N==null?X=A-q:X=(R-A)/2;let B;_==null?B=N-q:N==null?B=_-q:B=(N-_)/2;const de=e*q;c.push(t*g/n-t/2),c.push(de),c.push(o*x/a-o/2);let Q=new f(t/n,X*e,0).normalize(),W=new f(0,B*e,o/a).normalize(),ne=new f;ne.crossVectors(W,Q),h.push(ne.x),h.push(ne.y),h.push(ne.z),s.push(g/(n-1)),s.push(x/(a-1)),!(g==n-2||x==a-2)&&(l.push(g+x*d),l.push(g+1+x*d),l.push(g+1+(x+1)*d),l.push(g+x*d),l.push(g+1+(x+1)*d),l.push(g+(x+1)*d))}return i.setAttribute("position",new He(c,3)),i.setAttribute("normal",new He(h,3)),i.setAttribute("uv",new He(s,2)),i.setIndex(l),i}function Fo(t,o){o.wrapS=o.wrapT=J,Ke[t].object=o,console.log("Texture `"+t+"` loaded")}function Lo(t){const o=new Ee;o.onLoad=()=>{console.log("All textures loaded")};for(const e in Ke){console.log("Loading textures");const n=new Ge(o),a=Ke[e];a.object=n.load(a.url,Fo.bind(this,e),null,r=>{console.error(r)})}}Lo();const V={tierra:{url:to,object:null},ladrillos:{url:oo,object:null}};function To(t,o){o.wrapS=o.wrapT=J,V[t].object=o,console.log("Texture `"+t+"` loaded")}function Ao(t){const o=new Ee;o.onLoad=()=>{console.log("All textures loaded")};for(const e in V){console.log("Loading textures");const n=new Ge(o),a=V[e];a.object=n.load(a.url,To.bind(this,e),null,r=>{console.error(r)})}}const It=.25,Ce=2.5,ye=10,Se=.65;function wt(t=2,o=3,e=1,n=0,a=10){const r=o*2,i=a,c=a,l=t*(e+r)+e+i+c,h=n+o+It,s=new xt;for(let p=1;p<=t;++p)s.lineTo(i+p*e+(p-1)*r,0),s.moveTo(i+p*e+(p-1)*r,0),s.lineTo(i+p*e+(p-1)*r,n),s.arc(o,0,o,Math.PI,0,!0),s.moveTo(i+p*(e+r),0),s.lineTo(i+p*(e+r),0);s.lineTo(l,0),s.lineTo(l,h),s.lineTo(0,h),s.lineTo(0,0);const u=s.getPoints(),y=new Mt(u),v={curveSegments:24,steps:50,depth:Ce,bevelEnabled:!1},k=new kt(y,v);return k.translate(-l/2,0,-Ce/2),k}function Io(t=3,o=.15){const e=ye-.25,n=t*e;let a=[],r,i,c;for(let h=0;h<t;++h){for(let s=0;s<4;++s){r=new H(o,o,e),i=r.clone();const u=Math.sqrt(2*e*e);c=new H(o,o,u),s%2==0?(r.rotateZ(Math.PI/2),r.translate(0,h*e,(-1)**(s>>1)*e/2),c.rotateZ((-1)**(s>>1)*Math.PI/4),c.translate(0,h*e+e/2,(-1)**(s>>1)*e/2),i.translate((-1)**(s>>1)*e/2,h*e+e/2,(-1)**(s&1)*e/2)):(r.rotateX(Math.PI/2),r.translate((-1)**(s>>1)*e/2,h*e,0),c.rotateX((-1)**(s>>1)*Math.PI/4),c.translate((-1)**(s>>1)*e/2,h*e+e/2,0),i.translate((-1)**(s>>1)*e/2,h*e+e/2,(-1)**(s&1)*e/2)),a.push(r),a.push(c),a.push(i)}if(h+1==t)for(let s=0;s<4;++s)r=new H(o,o,e),s%2==0?(r.rotateZ(Math.PI/2),r.translate(0,(h+1)*e,(-1)**(s>>1)*e/2)):(r.rotateX(Math.PI/2),r.translate((-1)**(s>>1)*e/2,(h+1)*e,0)),a.push(r)}const l=be(a);return l.rotateZ(Math.PI/2),l.translate(n/2,e/2,0),l}function ft(t=1,o=3,e=0,n=0,a=10,r=0,i=1){const c=o*2,l=a,h=a,s=n+o+It,u=t*(e+c)+e+l+h,y=.3,v=new vt,k=wt(t,o,e,n,a);k.translate(0,0,-ye/2);const p=wt(t,o,e,n,a);p.translate(0,0,ye/2);const d=be([k,p]),g=new z(u,Se,ye+Ce);g.translate(0,s+Se/2,0),V.ladrillos.object.wrapS=J,V.ladrillos.object.wrapT=J,V.ladrillos.object.repeat.set(.75*.15,.75*.35);const x=new L({side:G,map:V.ladrillos.object}),A=new j(d,x);A.castShadow=!0,A.receiveShadow=!0,v.add(A);let R=g.attributes.uv.array;for(let W=0,ne=R.length;W<ne;W++)R[W]=W%2?R[W]*2.5:R[W]*30;const _=new j(g,x);v.add(_),_.castShadow=!0,_.receiveShadow=!0;const N=Io(r);N.translate(0,s+Se-y*2,0);const q=new L({side:G,transparent:!1,opacity:1,shininess:10,color:16777215}),X=new j(N,q);X.castShadow=!0,X.receiveShadow=!0,v.add(X);const B=new z(ye+Ce+.01,u+.01,.1);B.rotateZ(Math.PI/2),B.rotateX(Math.PI/2),B.translate(0,s+Se,0),V.tierra.object.wrapS=st,V.tierra.object.wrapT=st,V.tierra.object.repeat.set(1,5),V.tierra.object.anisotropy=16;const de=new L({side:G,map:V.tierra.object}),Q=new j(B,de);return Q.receiveShadow=!0,Q.castShadow=!1,v.add(Q),v}Ao();let re;const Go=new Pt([new f(-2,0,0),new f(-1,0,.5),new f(0,0,.55),new f(1,0,.5),new f(2,0,0)],!1);function Ye(t){return re==null&&console.log("railsPath is undefined"),[re.getPointAt(t),re.getTangentAt(t)]}function Eo(t,o,e){const n=new Y,a=new Y,r=new Y;let i=re.getPointAt(o),c=Go.getPointAt(t);c.multiplyScalar(.5),c.x*=1.25;let l=new f,h=new f,s=new f;l=re.getTangent(o),l.normalize(),h=new f(0,1,0),s.crossVectors(l,h),a.makeTranslation(i),n.identity(),r.identity(),r.makeTranslation(i),n.makeBasis(s,l,h),r.multiply(n),c.applyMatrix4(r);const u=c.x,y=c.y,v=c.z;e.set(u,y,v)}function zo(){return new Xe(Eo,250,250)}function gt(t=.5,o){return function(n,a,r){const i=new Y,c=new Y,l=new Y;new f;let h=re.getPointAt(a),s=new f(Math.cos(n*6.28)+o.x,o.y,Math.sin(n*6.28)+o.z);s.multiplyScalar(.1*t);let u=new f,y=new f,v=new f;u=re.getTangentAt(a),y=new f(0,1,0),v.crossVectors(u,y),c.makeTranslation(h),i.identity(),l.identity(),l.makeTranslation(h),i.makeBasis(v,u,y),l.multiply(i),s.applyMatrix4(l);const k=s.x,p=s.y,d=s.z;r.set(k,p,d)}}function Do(t=.35){let o=[];const e=gt(t,new f(9.5,0,t+8)),n=gt(t,new f(-9.5,0,t+8)),a=new Xe(e,100,500),r=new Xe(n,100,500);return o.push(a),o.push(r),be(o)}function Ho(){re=new Pt([new f(0,0,32),new f(28,0,32),new f(28,0,0),new f(5,0,-37),new f(-35,0,-30),new f(-10,0,0)],!0,"catmullrom",.75)}Ho();const Ro=""+new URL("sky_day_void-BqCvwB2K.jpg",import.meta.url).href,Bo=""+new URL("sky_night-DwhtyC8W.jpg",import.meta.url).href;let M,K,ie,Je,U,ge,bt,pe,D,Qe,F,C,te,T,E=[],I=[],$=[],je=[],w={ambient:{object:null},directional:{object:null},hemisphere:{object:null}},m={animationEnable:!1,showTrain:!0,currCameraIndex:0,nightMode:!0,showHelpers:!1,showFps:!0,currCameraName:"",shadows:!1},Ue,Fe=!1,se=!1,Le=!1,Te=!1,Ae=!1;const O=new f,we=new f,Vo=150,Uo=150,Gt=10,Et=-2.1,S={skyDay:{url:Ro,object:null},skyNight:{url:Bo,object:null},roca:{url:Ft,object:null},pasto:{url:Lt,object:null},tierra:{url:jt,object:null},madera:{url:ao,object:null},durmientes:{url:no,object:null},elevationMap:{url:tt,object:null},treeForbiddenMap:{url:Ct,object:null}};function et(){const t=window.innerWidth/window.innerHeight;for(let o=0;o<I.length;++o)I[o]!=null&&(I[o].aspect=t,I[o].updateProjectionMatrix());K.setSize(window.innerWidth,window.innerHeight)}function De(){switch(Qe.enabled=!1,Ie.style.display="none",ke.style.display="none",m.nightMode==!0&&(C.intensity=200,C.distance=100),D.unlock(),I[m.currCameraIndex].name){case"topView":Qe.enabled=!0;break;case"firstPersonCamera":Ie.style.display="block",ke.style.display="flex";break;case"trainCamera":case"trainConductorCamera":m.nightMode==!0&&(C.intensity=1e3,C.distance=1e3);break}et(),m.currCameraName=$[m.currCameraIndex]}function _o(){const t=I.length;m.currCameraIndex==0?m.currCameraIndex=t-1:m.currCameraIndex-=1,De()}function No(){const t=I.length;m.currCameraIndex==t-1?m.currCameraIndex=0:m.currCameraIndex+=1,De()}const Ie=document.getElementById("blocker"),ke=document.getElementById("instructions");function _e(t){switch(t){case"click":console.log("click"),D.lock();break;case"lock":console.log("lock"),ke.style.display="none",Ie.style.display="none";break;case"unlock":console.log("unlock"),Ie.style.display="block",ke.style.display="flex";break}}function yt(t){if(t.type=="keydown"){switch(t.code){case"ArrowUp":case"KeyW":Fe=!0,t.shiftKey&&(se=!0);break;case"ArrowLeft":case"KeyA":Te=!0;break;case"ArrowDown":case"KeyS":Le=!0;break;case"ArrowRight":case"KeyD":Ae=!0;break;case"KeyC":t.shiftKey?_o():No(),U!=null&&U.__controllers[6].updateDisplay();break;case"Space":m.animationEnable=!m.animationEnable,U!=null&&U.__controllers[0].updateDisplay();break}switch(t.key){case"Shift":se||(se=!0);break}}else{switch(t.code){case"ArrowUp":case"KeyW":Fe=!1,se=!1;break;case"ArrowLeft":case"KeyA":Te=!1;break;case"ArrowDown":case"KeyS":Le=!1;break;case"ArrowRight":case"KeyD":Ae=!1;break}switch(t.key){case"Shift":se&&(se=!1);break}}}function Xo(){const t=new le(50,window.innerWidth/window.innerHeight,.1,1e3);t.position.set(0,5,20),t.lookAt(-10,5,0),t.name="firstPersonCamera",I.push(t),$.push("Primera Persona"),D=new co(t,document.body),ke.addEventListener("click",function(){_e("click")}),D.addEventListener("lock",function(){_e("lock")}),D.addEventListener("unlock",function(){_e("unlock")}),M.add(D.getObject()),window.addEventListener("keydown",o=>{yt(o)}),window.addEventListener("keyup",o=>{yt(o)})}function Wo(){M=new Vt,K=new Ut,K.setPixelRatio(window.devicePixelRatio),K.setSize(window.innerWidth,window.innerHeight),K.shadowMap.type=_t,K.shadowMap.enabled=m.shadows,document.body.appendChild(K.domElement),ge=new ve,m.showFps==!0&&document.body.appendChild(ge.dom);const t=new le(35,window.innerWidth/window.innerHeight,.1,1e3);t.position.set(-32,38,70),t.lookAt(0,0,0),t.name="topView",I.push(t),$.push("Vista Global"),Qe=new Nt(t,K.domElement),w.ambient.object=new Xt(16777215),w.hemisphere.object=new Wt(16777215,0,.25),w.directional.object=new Ot(16777215,1),w.directional.object.position.set(-35,35,35),w.directional.object.castShadow=!0,w.directional.object.shadow.mapSize.width=512,w.directional.object.shadow.mapSize.height=512,w.directional.object.shadow.camera=new Zt(-65,65,45,-35,1,112);const o=new Ne(w.directional.object.shadow.camera);o.visible=m.showHelpers,M.add(o),E.push(o),M.add(w.ambient.object),M.add(w.hemisphere.object),M.add(w.directional.object),m.nightMode==!0?(w.ambient.object.visible=!1,w.hemisphere.object.intensity=0,w.directional.object.color.setHex(13491710),M.background=S.skyNight.object,w.directional.object.position.set(35,35,35)):(w.ambient.object.visible=!0,w.hemisphere.object.intensity=1,w.directional.object.intensity=1,w.directional.object.color.setHex(16777215),M.background=S.skyDay.object,w.directional.object.position.set(-35,35,35));const e=new $t(w.hemisphere.object,5);E.push(e);const n=new qt(w.directional.object,5);E.push(n);const a=new Kt(100,100);E.push(a);const r=new Yt(5);E.push(r);for(let i=0;i<E.length;++i)E[i].visible=m.showHelpers,M.add(E[i]);window.addEventListener("resize",et),et(),S.skyDay.object.mapping=ct,S.skyNight.object.mapping=ct,m.nightMode==!0?M.background=S.skyNight.object:M.background=S.skyDay.object}function Oo(t,o){o.wrapS=o.wrapT=J,S[t].object=o,console.log("Texture `"+t+"` loaded")}function Zo(t){const o=new Ee;o.onLoad=()=>{console.log("All textures loaded"),t()};for(const e in S){console.log("Loading textures");const n=new Ge(o),a=S[e];a.object=n.load(a.url,Oo.bind(this,e),null,r=>{console.error(r)})}}function $o(){const t=ft(1,3,0,0,10,2,2),o=ft(2,2,1,0,15,3,2);t.scale.set(.5,.5,.5),t.position.set(16,-.75,36),o.scale.set(.5,.5,.5),o.position.set(-14,-.25,-41);const e=new le(55,window.innerWidth/window.innerHeight,.1,1e4);e.position.set(-18,11,-2.75),e.lookAt(50,0,42),o.add(e),e.name="bridgeCamera",I.push(e),$.push("Vista del Puente"),t.castShadow=!0,t.receiveShadow=!0,o.castShadow=!0,o.receiveShadow=!0,M.add(t),M.add(o),je.push(t),je.push(o)}function qo(){F=bo();const t=new le(55,window.innerWidth/window.innerHeight,.1,1e4);t.position.set(0,7,-11),t.lookAt(0,20,100),F.add(t),t.name="trainConductorCamera",I.push(t),$.push("Cabina del Tren");const o=new le(55,window.innerWidth/window.innerHeight,.1,1e4);o.position.set(-12,6,-20),o.lookAt(0,10,15),F.add(o),o.name="trainCamera",I.push(o),$.push("Costado del Tren");const e=new le(55,window.innerWidth/window.innerHeight,.1,1e4);e.position.set(0,16,-10),e.lookAt(0,18,-100),F.add(e),e.name="trainBackCamera",I.push(e),$.push("Vista hacia atras desde la Cabina del Tren"),C=new Re(16777215,200,100,Math.PI/6,.5,1),F.add(C.target),F.add(C),C.position.set(0,4,5),C.target.position.set(0,-100,1e3),C.target.updateMatrixWorld(),te=new Re(16777215,10,3,Math.PI/6,.5,.5),F.add(te.target),F.add(te),te.position.set(0,3.25,15),te.target.position.set(0,0,-100),te.target.updateMatrixWorld(),T=new Re(16777215,10,16,Math.PI/3,.5,.5),F.add(T.target),F.add(T),T.position.set(0,5,5),T.target.position.set(0,-25,100),T.target.updateMatrixWorld(),C.castShadow=!0,C.shadow.mapSize.width=256,C.shadow.mapSize.height=256,C.shadow.camera.near=.5,C.shadow.camera.far=40,C.shadow.focus=1,T.castShadow=!0,T.shadow.mapSize.width=128,T.shadow.mapSize.height=128,T.shadow.camera.near=.5,T.shadow.camera.far=25,T.shadow.focus=1;const n=new Ne(C.shadow.camera),a=new Ne(T.shadow.camera);C.visible=m.nightMode,te.visible=m.nightMode,T.visible=m.nightMode,n.visible=m.showHelpers,a.visible=m.showHelpers,E.push(n),E.push(a),F.scale.set(.145,.145,.145),F.visible=m.showTrain,M.add(F)}function Ko(){const t=zo();S.durmientes.object.wrapS=J,S.durmientes.object.wrapT=J,S.durmientes.object.repeat.set(1,150),S.durmientes.object.anisotropy=16;const o=new L({side:G,map:S.durmientes.object}),e=new j(t,o);e.receiveShadow=!0,e.castShadow=!0,e.position.set(-1,1.25,-1),e.scale.set(1,1.5,1),M.add(e)}function Yo(){const t=Do(),o=new L({side:St,color:16777215}),e=new j(t,o);e.castShadow=!0,e.receiveShadow=!0,e.position.set(-1,1.25,-1),e.scale.set(1,1.5,1),M.add(e)}function Jo(){const t=new L({color:16777215,specular:3355443,side:G});let o={dirtSampler:{type:"t",value:S.tierra.object},rockSampler:{type:"t",value:S.roca.object},grassSampler:{type:"t",value:S.pasto.object},scale:{type:"f",value:3},terrainAmplitude:{type:"f",value:Gt},terrainAmplitudeBottom:{type:"f",value:Et},worldNormalMatrix:{type:"m4",value:null},dirtStepWidth:{type:"f",value:.2},rockStepWidth:{type:"f",value:.15}};return t.defines={USE_UV:!0},t.onBeforeCompile=function(e){e.uniforms.dirtSampler=o.dirtSampler,e.uniforms.rockSampler=o.rockSampler,e.uniforms.grassSampler=o.grassSampler,e.uniforms.scale=o.scale,e.uniforms.terrainAmplitude=o.terrainAmplitude,e.uniforms.terrainAmplitudeBottom=o.terrainAmplitudeBottom,e.uniforms.worldNormalMatrix=o.worldNormalMatrix,e.uniforms.dirtStepWidth=o.dirtStepWidth,e.uniforms.rockStepWidth=o.rockStepWidth,e.vertexShader=e.vertexShader.replace("vViewPosition = - mvPosition.xyz;",`vViewPosition = - mvPosition.xyz;
			 vWorldPosition = (modelMatrix*vec4(transformed,1.0)).xyz;`),e.vertexShader=`varying vec3 vWorldPosition;
		`+e.vertexShader,e.fragmentShader=`
uniform float scale;
uniform float terrainAmplitude;
uniform float terrainAmplitudeBottom;
uniform float dirtStepWidth;
uniform float rockStepWidth;

uniform sampler2D dirtSampler;
uniform sampler2D rockSampler;
uniform sampler2D grassSampler;
varying vec3 vWorldPosition;

`+e.fragmentShader,e.fragmentShader=e.fragmentShader.replace("void main() {",`
float myNormalizeFunc(float inputValue, float minValue, float maxValue) {
	return (inputValue - minValue) / (maxValue - minValue);
}

void main () {
	float heightFactor = vWorldPosition.y - terrainAmplitudeBottom;
	float heightFactorNormalized = myNormalizeFunc(heightFactor, 0.0, terrainAmplitude);
`),e.fragmentShader=e.fragmentShader.replace("#include <map_fragment>",`// calculamos las coordenadas UV en base a las coordenadas de mundo
vec2 uvCoords=vWorldPosition.xz/100.0;
vec2 myUV  = uvCoords*8.0;
vec2 myUV2 = uvCoords*scale;

vec3 grass = texture2D(grassSampler, uvCoords).xyz;
vec3 dirt  = texture2D(dirtSampler, uvCoords*4.0).xyz;
vec3 rock  = texture2D(rockSampler, uvCoords).xyz;

// si quisieramos podriamos usar la variabl vUv tambien que son las coordenadas UV del vertice

// muestreo de pasto a diferentes escalas, luego se combina con \`mix()\`
vec3 grass1 = texture2D(grassSampler, myUV2*1.00).xyz;
vec3 grass2 = texture2D(grassSampler, myUV2*3.13).xyz;
vec3 grass3 = texture2D(grassSampler, myUV2*2.37).xyz;
vec3 colorGrass = mix(mix(grass1,grass2,0.5),grass3,0.3);

// lo mismo para la textura de tierra
vec3 dirt1 = texture2D(dirtSampler, myUV2*3.77).xyz;
vec3 dirt2 = texture2D(dirtSampler, myUV2*1.58).xyz;
vec3 dirt3 = texture2D(dirtSampler, myUV2*1.00).xyz;
vec3 colorDirt = mix(mix(dirt1, dirt2, 0.5), dirt3, 0.3);

// lo mismo para la textura de roca
vec3 rock1 = texture2D(rockSampler,myUV2*0.40).xyz;
vec3 rock2 = texture2D(rockSampler,myUV2*2.38).xyz;
vec3 rock3 = texture2D(rockSampler,myUV2*3.08).xyz;
vec3 colorRock = mix(mix(rock1, rock2, 0.5), rock3,0.5);

float u = heightFactorNormalized;

float width2 = rockStepWidth;
float rockFactor = 2.00 - smoothstep(0.0, width2, u) - smoothstep(1.0, 1.00 - width2, u);

float width = dirtStepWidth;
float s1 = smoothstep(0.00, width, u);
float s2 = smoothstep(width, width*2.0, u);
float s3 = smoothstep(0.50, 0.50 + width, u);
float s4 = smoothstep(0.50 + width, 0.50 + width*2.0, u);
float dirtFactor = (s1 - s2) + (s3 - s4);

float grassFactor = smoothstep(0.0, 0.35, u) - smoothstep(0.35, 1.00, u);

vec3 colorDirtGrass = mix(colorDirt, colorGrass, grassFactor);
vec3 colorDirtGrassDirt = mix(colorDirtGrass, colorDirt, dirtFactor);
vec3 color = mix(colorDirtGrassDirt, colorRock, rockFactor);

diffuseColor = vec4(color, 1.0);

// leemos los colores de las texturas
// vec4 grassColor = texture2D(grassSampler,uvCoords);
// vec4 rockColor = texture2D(rockSampler,uvCoords);

// mezclamos los colores en base a la altura del vertice
// diffuseColor = mix(grassColor, rockColor, smoothstep(0.0,5.0,vWorldPosition.y));`)},t}function Qo(){bt=jo(100,100,Gt,Vo,Uo,S.elevationMap.object),console.log("Applying textures");const e=Jo();pe=new j(bt,e),pe.castShadow=!0,pe.receiveShadow=!0,M.add(pe),pe.position.set(0,Et,0),je.push(pe),console.log("Generating water");const n=new eo(100/2,100-1.25),a=new L({color:1223679,side:St}),r=new j(n,a);r.rotateX(Math.PI/2),r.position.set(0,0,-.65),r.castShadow=!1,r.receiveShadow=!0,M.add(r)}function en(){const t=yo(24,12,.5,46);S.madera.object.wrapS=J,S.madera.object.wrapT=J,S.madera.object.repeat.set(.1,.1),S.madera.object.anisotropy=16;const o=new L({side:G,map:S.madera.object}),e=new j(t,o);e.castShadow=!0,e.receiveShadow=!0,e.scale.set(.5,.5,.5);const n=Ye(.32);e.position.set(n[0].x,0,n[0].z),e.lookAt(n[1].x*1e3,0,n[1].z*1e3),M.add(e);const a=new le(65,window.innerWidth/window.innerHeight,.1,1e4);a.position.set(-1,12,18),a.lookAt(0,10,-10),a.name="tunnelCamera",e.add(a),I.push(a),$.push("Camara del Tunel")}function tn(t=50){const[o,e]=ko(t);M.add(o),M.add(e),o.castShadow=!0,o.receiveShadow=!0,e.castShadow=!0,e.receiveShadow=!0}function on(){console.log("Toggling night mode"),console.log(m.nightMode),m.nightMode==!0?(w.ambient.object.visible=!1,w.hemisphere.object.intensity=0,w.directional.object.color.setHex(13491710),M.background=S.skyNight.object,w.directional.object.position.set(35,35,35),C.visible=!0,te.visible=!0,T.visible=!0):(w.ambient.object.visible=!0,w.hemisphere.object.intensity=1,w.directional.object.intensity=1,w.directional.object.color.setHex(16777215),M.background=S.skyDay.object,w.directional.object.position.set(-35,35,35),C.visible=!1,te.visible=!1,T.visible=!1)}function nn(){U=new Jt({width:250}),U.add(m,"animationEnable",!0).name("Animaciones"),U.add(m,"showTrain").name("Mostrar tren").onChange(function(){F.visible=!F.visible}),U.add(m,"nightMode",!1).name("Modo noche").onChange(on),U.add(m,"showHelpers",!0).name("Mostrar Guias").onChange(function(){for(let t=0;t<E.length;++t)E[t].visible=m.showHelpers,M.add(E[t])}),U.add(m,"showFps",!0).name("Mostrar FPS").onChange(function(){m.showFps==!0?document.body.appendChild(ge.dom):document.body.removeChild(ge.dom)}),U.add(m,"shadows",!0).name("Sombras").onChange(function(){K.shadowMap.enabled=m.shadows,M.traverse(function(t){t.material&&(t.material.needsUpdate=!0)})}),U.add(m,"currCameraName",$).name("Camara").setValue($[m.currCameraIndex]).onChange(function(){m.currCameraIndex=$.indexOf(m.currCameraName),De()})}function an(){console.log("Building scene"),en(),tn(200),Qo(),Ko(),Yo(),qo(),$o()}function zt(){requestAnimationFrame(zt),ge.begin();const t=.001;if(m.animationEnable&&(ie=ie<1-t?ie+t:0),F.visible){Tt(ie*200),Ye(ie);const r=Ye(ie);let i=r[0].x,c=r[0].z;F.position.set(-1+i,2.3,-1+c),F.lookAt(r[1].x*1e3,1.9,r[1].z*1e3)}let o=performance.now();const e=1.6;if(D.isLocked===!0){Ue=new Qt;var n=new f;n.copy(D.getObject().position),n.y+=2;var a=new f(0,-1,0);Ue.set(n,a);const r=Ue.intersectObjects(je);let i;r==null||r[0]==null?i=0:i=r[0].point.y;const c=(o-Je)/1e3;O.x-=O.x*11*c,O.z-=O.z*11*c,O.y-=9.8*100*c,we.z=Number(Fe)-Number(Le),we.x=Number(Ae)-Number(Te),we.normalize(),(Fe||Le)&&(se?O.z-=we.z*200*c:O.z-=we.z*100*c),(Te||Ae)&&(O.x-=we.x*100*c),D.moveRight(-O.x*c),D.moveForward(-O.z*c),D.getObject().position.y=i<0?e:i+e,D.getObject().position.y<i+e&&(O.y=0,D.getObject().position.y=e)}Je=o,K.render(M,I[m.currCameraIndex]),ge.end()}function rn(){Wo(),Xo(),ie=.9,Je=performance.now(),an(),nn(),De(),zt()}Zo(rn);
